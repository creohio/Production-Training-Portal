<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Training by Shift — Charts (By Department)</title>
<style>
  :root{
    --bg:#f8fafc; --ink:#0f172a; --muted:#64748b; --accent:#2563eb;
    --card:#ffffff; --line:#e5e7eb;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{background:#eef2ff;padding:12px 16px;border-bottom:1px solid #dbeafe}
  header h1{margin:0;font-size:18px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:0 0 14px 0}
  h2{margin:0 0 8px 0;font-size:18px}
  h3{margin:0 0 8px 0;font-size:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .right{margin-left:auto;text-align:right}
  .muted{color:var(--muted);font-size:12px}
  canvas{max-width:100%}
  .grid-3{display:grid;gap:16px;grid-template-columns:repeat(1,minmax(0,1fr))}
  @media(min-width:900px){.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .btn{appearance:none;border:1px solid #cbd5e1;background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .dept{margin-top:18px}
  .badge{display:inline-block;padding:2px 8px;border:1px solid #cbd5e1;border-radius:999px;font-size:12px;background:#fff}
</style>
</head>
<body>
<header><h1>Training by Shift — Charts (Grouped by Department)</h1></header>
<div class="wrap">

  <section class="card">
    <div class="row">
      <h2>Overview</h2>
      <div class="right">
        <button class="btn" id="btnExportCounts">Export Counts CSV</button>
        <button class="btn" id="btnExportQuiz">Export Quiz Results CSV</button>
      </div>
    </div>
    <div id="dbKeyNote" class="muted" style="margin-top:6px;"></div>
    <div class="muted" style="margin-top:6px;">Each bar = # of active employees on that shift who have a training record for that machine within the listed department.</div>
  </section>

  <div id="departmentsContainer"></div>

</div>

<script>
/* ======================= Detect existing portal DB key ======================= */
function detectPortalKey() {
  const keys = Object.keys(localStorage).filter(k => k.startsWith('ptp_v3:'));
  if (keys.length === 0) return null;
  // Heuristic: choose the largest DB value
  let bestKey = keys[0], bestLen = (localStorage.getItem(keys[0])||'').length;
  for (const k of keys) {
    const len = (localStorage.getItem(k)||'').length;
    if (len > bestLen) { bestLen = len; bestKey = k; }
  }
  return bestKey;
}

const LS_KEY = detectPortalKey();
const DB = (() => {
  try {
    return LS_KEY ? JSON.parse(localStorage.getItem(LS_KEY)) : {employees:[], machines:[], training:[], tests:[], quizResults:[]};
  } catch {
    return {employees:[], machines:[], training:[], tests:[], quizResults:[]};
  }
})();

document.getElementById('dbKeyNote').textContent = LS_KEY
  ? `Using data from localStorage key: ${LS_KEY}`
  : 'No portal data found in this browser (expected key prefix: ptp_v3:).';

// -------- helpers --------
function groupMachinesByDept() {
  const byDept = {};
  for (const m of (DB.machines || [])) {
    const d = (m && m.department) ? String(m.department) : 'Unassigned';
    if (!byDept[d]) byDept[d] = [];
    byDept[d].push(m);
  }
  // Stable sort department names
  const entries = Object.entries(byDept).sort((a,b)=>a[0].localeCompare(b[0]));
  return entries;
}

function employeesOnShift(shift) {
  return (DB.employees || []).filter(e => e && e.active !== false && (e.shift || '1st') === shift);
}

function hasTraining(empId, machineId) {
  return (DB.training || []).some(t => t && t.employeeId === empId && t.machineId === machineId);
}

function byShiftCountsForMachines(machineList, shift) {
  const emps = employeesOnShift(shift);
  const labels = machineList.map(m => m.name);
  const values = machineList.map(m => {
    let n = 0;
    for (const e of emps) if (hasTraining(e.id, m.id)) n++;
    return n;
  });
  return { labels, values };
}

function drawBarChart(canvas, labels, values) {
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  const left=40, right=10, bottom=40, top=20;
  const innerW = W-left-right, innerH = H-top-bottom;
  const n = Math.max(1, labels.length);
  const gap = 8;
  const barW = Math.max(4, (innerW - gap*(n-1)) / n);
  const maxV = Math.max(1, ...values);

  // axis
  ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(left, H-bottom); ctx.lineTo(W-right, H-bottom); ctx.stroke();

  ctx.font = '12px system-ui';

  // bars
  for (let i=0;i<labels.length;i++) {
    const v = values[i] || 0;
    const bh = (v/maxV) * innerH;
    const x = left + i*(barW+gap);
    const y = H-bottom - bh;
    ctx.fillStyle = '#2563eb';
    ctx.fillRect(x, y, barW, bh);
    ctx.fillStyle = '#0f172a';
    ctx.textAlign = 'center';
    ctx.fillText(String(v), x+barW/2, y-4);

    ctx.save();
    ctx.translate(x+barW/2, H-bottom+12);
    if (labels.length > 8) { ctx.rotate(-Math.PI/3); ctx.textAlign='right'; }
    else { ctx.textAlign='center'; }
    ctx.fillText(labels[i], 0, 0);
    ctx.restore();
  }

  // y ticks
  const ticks = Math.min(5, maxV);
  ctx.fillStyle = '#64748b'; ctx.textAlign = 'right';
  for (let t=0;t<=ticks;t++) {
    const val = Math.round((t/ticks)*maxV);
    const yy = H-bottom - (val/maxV)*innerH;
    ctx.fillText(String(val), left-6, yy+4);
    ctx.strokeStyle = '#e5e7eb'; ctx.beginPath(); ctx.moveTo(left,yy); ctx.lineTo(W-right,yy); ctx.stroke();
  }
}

// -------- render per-department cards (each with 3 shift charts) --------
function renderDepartments() {
  const container = document.getElementById('departmentsContainer');
  container.innerHTML = '';
  const depts = groupMachinesByDept();
  if (depts.length === 0) {
    const info = document.createElement('div');
    info.className = 'card';
    info.textContent = 'No machines found. Add machines with a "department" field to see grouped charts.';
    container.appendChild(info);
    return;
  }

  for (const [deptName, machines] of depts) {
    const wrap = document.createElement('section');
    wrap.className = 'dept';
    wrap.innerHTML = `
      <div class="card">
        <div class="row">
          <h2>${deptName}</h2>
          <span class="badge">${machines.length} machine${machines.length!==1?'s':''}</span>
        </div>
        <div class="grid-3" style="margin-top:10px;">
          <div class="card">
            <h3>1st Shift</h3>
            <canvas width="360" height="220" aria-label="1st shift chart"></canvas>
          </div>
          <div class="card">
            <h3>2nd Shift</h3>
            <canvas width="360" height="220" aria-label="2nd shift chart"></canvas>
          </div>
          <div class="card">
            <h3>3rd Shift</h3>
            <canvas width="360" height="220" aria-label="3rd shift chart"></canvas>
          </div>
        </div>
      </div>
    `;
    container.appendChild(wrap);

    const canvases = wrap.querySelectorAll('canvas');
    const s1 = byShiftCountsForMachines(machines, '1st');
    const s2 = byShiftCountsForMachines(machines, '2nd');
    const s3 = byShiftCountsForMachines(machines, '3rd');
    drawBarChart(canvases[0], s1.labels, s1.values);
    drawBarChart(canvases[1], s2.labels, s2.values);
    drawBarChart(canvases[2], s3.labels, s3.values);
  }
}

// -------- CSV exports --------
function exportCountsCSV() {
  // One row per department+machine, with three shift counts
  const rows = [['Department','Machine','1st Shift','2nd Shift','3rd Shift']];
  const depts = groupMachinesByDept();
  for (const [deptName, machines] of depts) {
    const s1 = byShiftCountsForMachines(machines, '1st');
    const s2 = byShiftCountsForMachines(machines, '2nd');
    const s3 = byShiftCountsForMachines(machines, '3rd');
    machines.forEach((m, i) => {
      rows.push([
        deptName,
        m.name,
        s1.values[i] || 0,
        s2.values[i] || 0,
        s3.values[i] || 0
      ]);
    });
  }
  const blob = new Blob([rows.map(r=>r.join(',')).join('\\n')], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'training_by_department_and_shift.csv'; a.click();
}

function lookup(mapArr, id, key='id') {
  if (!Array.isArray(mapArr)) return null;
  for (const x of mapArr) if (x && String(x[key]) === String(id)) return x;
  return null;
}

function exportQuizResultsCSV() {
  // Assumptions:
  // DB.quizResults = [{employeeId, testId, score, total, date, questionResults:[{questionId, correct, questionText, selected, correctAnswer}]}]
  // DB.tests = [{id, title}] (optional)
  // Fallbacks are handled if missing.
  const results = (DB.quizResults || []);
  if (results.length === 0) {
    alert('No quiz results found in DB.quizResults.');
    return;
  }
  const rows = [[
    'Employee',
    'EmployeeId',
    'Test',
    'TestId',
    'Date',
    'Score',
    'Total',
    'Percent',
    'MissedCount',
    'MissedQuestions' // pipe-separated "Q: text (selected -> correct)"
  ]];

  for (const r of results) {
    const emp = lookup(DB.employees, r.employeeId) || {name:'Unknown'};
    const test = lookup(DB.tests, r.testId) || {title: 'Test ' + (r.testId ?? '')};
    const total = r.total ?? (Array.isArray(r.questionResults) ? r.questionResults.length : 0);
    const score = r.score ?? (Array.isArray(r.questionResults) ? r.questionResults.filter(q=>q && q.correct===true).length : 0);
    const pct = total ? Math.round((score/total)*1000)/10 : 0;

    const missed = (r.questionResults || []).filter(q=>q && q.correct===false);
    const missedFmt = missed.map(q => {
      const qt = (q.questionText || ('Q'+(q.questionId ?? ''))) + '';
      const sel = (q.selected ?? '').toString().replace(/\\s+/g,' ').trim();
      const corr = (q.correctAnswer ?? '').toString().replace(/\\s+/g,' ').trim();
      return `Q: ${qt} (${sel} -> ${corr})`;
    }).join(' | ');

    rows.push([
      emp.name || 'Unknown',
      r.employeeId ?? '',
      test.title || '',
      r.testId ?? '',
      r.date || '',
      score,
      total,
      pct,
      missed.length,
      missedFmt.replace(/\\n/g,' ').replace(/,/g,';') // keep CSV clean
    ]);
  }

  const blob = new Blob([rows.map(r=>r.join(',')).join('\\n')], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'quiz_results_with_missed_questions.csv'; a.click();
}

// Bind buttons
document.getElementById('btnExportCounts').onclick = exportCountsCSV;
document.getElementById('btnExportQuiz').onclick = exportQuizResultsCSV;

// Initial render
renderDepartments();
</script>
</body>
</html>
