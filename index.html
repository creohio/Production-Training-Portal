<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Production Training Portal</title>
<style>
  :root{
    --bg:#f8fafc; --ink:#0f172a; --muted:#64748b; --accent:#2563eb;
    --card:#ffffff; --line:#e5e7eb; --good:#16a34a; --bad:#dc2626; --warn:#d97706;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{background:#eef2ff;padding:12px 16px;border-bottom:1px solid #dbeafe}
  header h1{margin:0;font-size:18px}
  .tabs{display:flex;flex-wrap:wrap;gap:8px;background:#e2e8f0;padding:8px 10px;border-bottom:1px solid var(--line)}
  .tab{appearance:none;border:1px solid #cbd5e1;background:#f1f5f9;padding:8px 12px;border-radius:8px;cursor:pointer}
  .tab.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:600}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  section[hidden]{display:none}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:0 0 14px 0}
  h2{margin:0 0 8px 0;font-size:18px}
  h3{margin:0 0 8px 0;font-size:16px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,select,textarea{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;color:#000}
  input[type="checkbox"],input[type="radio"]{width:auto}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .btn{appearance:none;border:1px solid #cbd5e1;background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:600}
  .btn.good{background:var(--good);border-color:var(--good);color:#fff;font-weight:600}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#fff}
  .muted{color:var(--muted);font-size:12px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:8px;border-top:1px solid var(--line);vertical-align:top}
  th{text-align:left;color:var(--muted);font-weight:600}
  .qbox{border:1px dashed #cbd5e1;border-radius:10px;padding:10px;margin:8px 0}
  .optrow{display:flex;gap:8px;align-items:center;margin:4px 0}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f8fafc;font-size:12px}
  .pill-ok{background:#ecfdf5;border-color:#86efac;color:#065f46}
  .pill-bad{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
  .pill-warn{background:#fff7ed;border-color:#fed7aa;color:#7c2d12}
  canvas{max-width:100%}
  .right{margin-left:auto;text-align:right}
</style>
</head>
<body>
<header><h1>Production Training Portal</h1></header>

<div class="tabs" id="tabs"></div>

<div class="wrap">

  <!-- LOGIN -->
  <section class="card" data-page="login">
    <h2>Login</h2>
    <div class="grid g3">
      <div>
        <label>Username</label><input id="loginUser" autocomplete="username"/>
      </div>
      <div>
        <label>Password</label><input id="loginPass" type="password" autocomplete="current-password"/>
      </div>
      <div class="row" style="align-self:end;">
        <button class="btn primary" id="btnLogin">Login</button>
        <button class="btn" id="btnLogout">Logout</button>
      </div>
    </div>
    <div id="loginStatus" class="muted" style="margin-top:6px;"></div>
    <div class="muted">Demo auth using LocalStorage (not secure).</div>
    <div id="storageWarn" class="muted" style="margin-top:6px;color:#7c2d12;"></div>
  </section>

  <!-- EMPLOYEES -->
  <section class="card" data-page="employees" hidden>
    <h2>Employees</h2>
    <div class="grid g3">
      <div>
        <label>Name</label><input id="eName"/>
      </div>
      <div>
        <label>Username</label><input id="eUser"/>
      </div>
      <div>
        <label>Password</label><input id="ePass" type="password"/>
      </div>
      <div>
        <label>Department</label><input id="eDept"/>
      </div>
      <div>
        <label>Shift</label>
        <select id="eShift"><option value="1st">1st</option><option value="2nd">2nd</option><option value="3rd">3rd</option></select>
      </div>
      <div>
        <label>Hire Date</label><input id="eHire" type="date"/>
      </div>
      <div>
        <label>Active</label><select id="eActive"><option value="true">Yes</option><option value="false">No</option></select>
      </div>
      <div>
        <label>Admin</label><select id="eAdmin"><option value="false">No</option><option value="true">Yes</option></select>
      </div>
      <div class="row" style="align-self:end;">
        <input type="hidden" id="eId" value="">
        <button class="btn primary" id="btnSaveEmp">Add</button>
        <button class="btn" id="btnCancelEmp" hidden>Cancel</button>
        <button class="btn" id="btnExport">Export JSON</button>
        <label class="btn"><input type="file" id="impJson" accept=".json" style="display:none">Import JSON</label>
        <button class="btn warn" id="btnRestoreBackup" type="button">Restore Backup</button>
        <button class="btn bad" id="btnResetAdmin" type="button" title="Recreate admin/admin if you’re locked out">Reset Admin</button>
      </div>
    </div>

    <div class="card">
      <h3>Import Employees (CSV)</h3>
      <div class="muted">FirstName,LastName,Username,Dept,Shift,Active(true/false),IsAdmin(true/false),HireDate(YYYY-MM-DD)</div>
      <div class="row"><input type="file" id="empCsv" accept=".csv"/><button class="btn" id="btnImpEmp">Import CSV</button></div>
    </div>

    <div class="card">
      <div class="row">
        <h3 class="mb8">Directory</h3>
        <div class="right muted" id="empCount"></div>
      </div>
      <table id="empTable"><thead><tr>
        <th>Name</th><th>Username</th><th>Dept</th><th>Shift</th><th>Hire</th><th>Status</th><th>Role</th><th>Actions</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- MACHINES -->
  <section class="card" data-page="machines" hidden>
    <h2>Machines</h2>
    <div class="grid g3">
      <div>
        <label>Name</label><input id="mName"/>
      </div>
      <div>
        <label>Department</label><input id="mDept"/>
      </div>
      <div>
        <label>Active</label><select id="mActive"><option value="true">Yes</option><option value="false">No</option></select>
      </div>
      <div class="row" style="align-self:end;">
        <button class="btn primary" id="btnAddMachine">Add</button>
      </div>
    </div>

    <div class="card">
      <h3>Import Machines (CSV)</h3>
      <div class="muted">Name,Location,Department,Active(true/false)</div>
      <div class="row"><input type="file" id="mCsv" accept=".csv"/><button class="btn" id="btnImpM">Import CSV</button></div>
    </div>

    <div class="card">
      <h3>All Machines</h3>
      <table id="mTable"><thead><tr><th>Name</th><th>Department</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- QUIZZES -->
  <section class="card" data-page="quizzes" hidden>
    <h2>Quizzes</h2>
    <div class="grid g3">
      <div>
        <label>Title</label><input id="qTitle"/>
      </div>
      <div>
        <label>Passing (%)</label><input id="qPass" type="number" min="1" max="100" value="80"/>
      </div>
      <div>
        <label>Active</label><select id="qActive"><option value="true">Yes</option><option value="false">No</option></select>
      </div>
    </div>

    <label>Certifies Machines (Ctrl/Cmd-Multi Select)</label>
    <select id="qMachines" multiple size="6" style="height:130px;"></select>

    <div class="qbox">
      <strong>Questions</strong> <span class="muted">(add single or multi-select; mark correct answers)</span>
      <div id="qList"></div>
      <div class="row"><button class="btn" id="btnAddSingle">+ Single-choice</button><button class="btn" id="btnAddMulti">+ Multi-select</button></div>
    </div>

    <div class="row">
      <button class="btn primary" id="btnSaveQuiz">Save Quiz</button>
      <button class="btn" id="btnCancelQuiz" hidden>Cancel Edit</button>
    </div>

    <div class="card">
      <h3>All Quizzes</h3>
      <table id="qTable"><thead><tr><th>Title</th><th>Pass</th><th>#Qs</th><th>Machines</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- ASSIGNMENTS -->
  <section class="card" data-page="assign" hidden>
    <h2>Assignments</h2>
    <div class="grid g3">
      <div>
        <label>Employee</label><select id="asEmp"></select>
      </div>
      <div>
        <label>Quiz</label><select id="asQuiz"></select>
      </div>
      <div>
        <label>Required</label><select id="asReq"><option value="true">Yes</option><option value="false">No</option></select>
      </div>
      <div>
        <label>Due Date (optional)</label><input id="asDue" type="date"/>
      </div>
      <div class="row" style="align-self:end;">
        <button class="btn primary" id="btnAssign">Assign</button>
        <button class="btn" id="btnAssignDept">Assign By Dept</button>
        <button class="btn" id="btnAssignAll">Assign All Active</button>
      </div>
    </div>
    <div class="card">
      <h3>Assignments</h3>
      <table id="asTable"><thead><tr><th>Employee</th><th>Quiz</th><th>Required</th><th>Assigned</th><th>Due</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <!-- BACKFILL -->
  <section class="card" data-page="backfill" hidden>
    <h2>Backfill</h2>
    <div class="grid g3">
      <div>
        <label>Employee</label><select id="bfEmp"></select>
      </div>
      <div>
        <label>Quiz</label><select id="bfQuiz"></select>
      </div>
      <div>
        <label>Score (%)</label><input id="bfScore" type="number" value="100" min="0" max="100"/>
      </div>
      <div>
        <label>Completion Date</label><input id="bfDate" type="date"/>
      </div>
      <div class="row" style="align-self:end;"><button class="btn good" id="btnBackfill">Record Completion</button></div>
    </div>

    <div class="card">
      <h3>Import Completions (CSV)</h3>
      <div class="muted">EmployeeUsername,QuizTitle,CompletedOn(YYYY-MM-DD),Score</div>
      <div class="row"><input type="file" id="bfCsv" accept=".csv"/><button class="btn" id="btnImpBf">Import CSV</button></div>
    </div>
  </section>

  <!-- REPORTS -->
  <section class="card" data-page="reports" hidden>
    <h2>Reports</h2>
    <div class="grid g2">
      <div class="card">
        <h3>Training Matrix</h3>
        <div class="row"><button class="btn" id="btnExportMatrix">Export CSV</button></div>
        <div id="matrixNote" class="muted">Employees × Machines (✓ if trained, date shown). Includes Dept & Hire Date.</div>
        <div id="matrixArea" class="muted" style="margin-top:8px;">Use CSV export for spreadsheet view.</div>
      </div>
      <div class="card">
        <h3>Shift Counts</h3>
        <div id="shiftCounts" class="muted"></div>
      </div>
    </div>
    <div class="card">
      <h3>Audit Log</h3>
      <div class="muted">Recent admin actions</div>
      <ul id="auditList"></ul>
    </div>
  </section>

  <!-- SHIFTS -->
  <section class="card" data-page="shifts" hidden>
    <h2>Shifts Overview</h2>
    <div id="shiftTableArea"></div>
  </section>

  <!-- PROFILE -->
  <section class="card" data-page="profile" hidden>
    <h2>My Profile</h2>
    <div id="pInfo" class="row"></div>

    <div class="grid g2" style="margin-top:10px;">
      <div class="card">
        <h3>Machines I Can Run</h3>
        <ul id="pTrained"></ul>
      </div>
      <div class="card">
        <h3>Completed Quizzes</h3>
        <ul id="pCompleted"></ul>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <h3>Assigned Quizzes</h3>
        <div class="right"><canvas id="pChart" width="360" height="160" aria-label="Completion chart"></canvas></div>
      </div>
      <ul id="pAssigned"></ul>
    </div>
  </section>

  <!-- TAKE QUIZ -->
  <section class="card" data-page="take" hidden>
    <h2 id="takeTitle">Take Quiz</h2>
    <form id="takeForm"></form>
    <div class="row" style="margin-top:10px;">
      <button class="btn good" id="btnSubmitTake">Submit</button>
      <button class="btn" id="btnCancelTake" type="button">Cancel</button>
    </div>
    <div id="takeResult" class="muted" style="margin-top:8px;"></div>
    <div id="takeReview" class="qbox" hidden></div>
  </section>

</div>

<script>
/* ======================= Namespaced Storage Keys ======================= */
const NS = (location.host + location.pathname.replace(/\/$/, ''));
const LS = `ptp_v3:${NS}`;
const SKEY = `ptp_session:${NS}`;
const SEED_FLAG = `ptp_seeded_v3:${NS}`;

/* ======================= Storage Health Check ======================= */
(function(){
  try{
    const testKey = '__ptp_test__';
    localStorage.setItem(testKey, '1');
    localStorage.removeItem(testKey);
  }catch(e){
    const w = document.getElementById('storageWarn');
    if(w){ w.textContent = 'Warning: Your browser is blocking localStorage (privacy mode or cross-site tracking prevention). Changes will not persist.'; }
  }
})();

/* ======================= DB & Session ======================= */
const emptyDb = { employees:[], machines:[], quizzes:[], assignments:[], attempts:[], training:[], audit:[] };
function load(){
  try{
    const j = localStorage.getItem(LS);
    return j ? JSON.parse(j) : structuredClone(emptyDb);
  }catch{ return structuredClone(emptyDb); }
}
let db = load();

let session=null;
try{ session = JSON.parse(localStorage.getItem(SKEY)||'null'); }catch{ session=null; }

/* ===== Helpers ===== */
function nextId(col){ let m=0; db[col].forEach(r=>m=Math.max(m,r.id||0)); return m+1; }
function getMe(){ return session ? db.employees.find(e=>e.id===session.userId) : null; }
function csv(v){ if(v==null) v=""; v=String(v); if(v.includes(",")||v.includes('"')) return `"${v.replaceAll('"','""')}"`; return v; }
function parseCsv(text){
  const lines = text.replace(/\r/g,"").split("\n").filter(l=>l.trim().length);
  const out=[];
  for(const line of lines){
    const row=[]; let cur="",q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i], n=line[i+1];
      if(c==='"'){ if(q && n==='"'){cur+='"'; i++;} else q=!q; }
      else if(c===',' && !q){ row.push(cur); cur=""; }
      else cur+=c;
    }
    row.push(cur); out.push(row.map(v=>v.trim()));
  }
  return out;
}

/* ===== Persistence with rolling backup ===== */
function save(auditNote=null){
  localStorage.setItem(LS, JSON.stringify(db));
  localStorage.setItem(LS + "_backup", JSON.stringify(db));
  if(auditNote && getMe()?.isAdmin){
    db.audit.unshift(`${new Date().toLocaleString()} — ${getMe().username}: ${auditNote}`);
    db.audit = db.audit.slice(0,200);
    localStorage.setItem(LS, JSON.stringify(db));
    localStorage.setItem(LS + "_backup", JSON.stringify(db));
  }
  render();
}
function restoreBackup(){
  const snap = localStorage.getItem(LS + "_backup");
  if(!snap){ alert("No backup snapshot found."); return; }
  if(!confirm("Restore last backup snapshot? This will overwrite the current state.")) return;
  try{
    db = JSON.parse(snap);
    localStorage.setItem(LS, snap);
    ensureAdmin();
    render();
    alert("Backup restored.");
  }catch{ alert("Backup could not be parsed."); }
}

/* ===== Seed once + ensure admin always exists ===== */
function addEmployee({name,username,password,isAdmin,active,dept,shift,hire}, audit=true){
  const e={id:nextId("employees"),name,username,password,isAdmin:!!isAdmin,active:active!==false,dept:dept||"",shift:shift||"1st",hire:hire||""};
  db.employees.push(e); if(audit) save(`Add employee ${username}`); return e;
}
function addMachine({name,dept,active}, audit=true){
  const m={id:nextId("machines"), name, dept:dept||"", active:active!==false};
  db.machines.push(m); if(audit) save(`Add machine ${name}`); return m;
}
function ensureAdmin(){
  const anyAdmin = db.employees.some(e=>e.isAdmin);
  if(!anyAdmin){
    addEmployee({name:"Admin", username:"admin", password:"admin", isAdmin:true, active:true, dept:"", shift:"1st", hire:""}, false);
    localStorage.setItem(LS, JSON.stringify(db));
  }
}
(function seedOnce(){
  if(!localStorage.getItem(SEED_FLAG)){
    const dbEmpty =
      (db.employees?.length||0)===0 &&
      (db.machines?.length||0)===0 &&
      (db.quizzes?.length||0)===0;

    if(dbEmpty){
      const e1 = addEmployee({name:"Admin", username:"admin", password:"admin", isAdmin:true, active:true, dept:"HR", shift:"1st", hire:"2024-01-01"}, false);
      const e2 = addEmployee({name:"Casey Carter", username:"ccarter", password:"test", isAdmin:false, active:true, dept:"Wire", shift:"2nd", hire:"2024-03-15"}, false);
      const m1 = addMachine({name:"Draw Bench #1", dept:"Wire", active:true}, false);
      const m2 = addMachine({name:"Pickle House", dept:"Wire", active:true}, false);

      const qid = nextId("quizzes");
      db.quizzes.push({
        id: qid, title:"Draw Bench Safety", passPercent:80, active:true,
        machineIds:[m1.id],
        questions:[
          {id:1,type:"single",text:"What PPE is required?", options:[
            {id:1,text:"Safety glasses and gloves",correct:true},
            {id:2,text:"None",correct:false}
          ]},
          {id:2,type:"single",text:"Where is the E-stop located?", options:[
            {id:1,text:"On the operator panel",correct:true},
            {id:2,text:"Behind the machine",correct:false}
          ]},
          {id:3,type:"multi",text:"Which are valid lockout points? (pick all that apply)", options:[
            {id:1,text:"Main power disconnect",correct:true},
            {id:2,text:"Compressed air supply",correct:true},
            {id:3,text:"Coolant reservoir",correct:false}
          ]}
        ]
      });
      save("Seed sample data");
    }
    localStorage.setItem(SEED_FLAG, '1');
  }
  ensureAdmin();
})();

/* ======================= Tabs & Role Gating ======================= */
const PAGES = [
  ["login","Login"],
  ["employees","Employees", true],
  ["machines","Machines", true],
  ["quizzes","Quizzes", true],
  ["assign","Assignments", true],
  ["backfill","Backfill", true],
  ["reports","Reports", true],
  ["shifts","Shifts", true],
  ["profile","My Profile"],
  ["take","Take Quiz"]
];
const tabsEl=document.getElementById("tabs");
PAGES.forEach(([id,label,isAdmin],i)=>{
  const b=document.createElement("button"); b.className="tab"+(i===0?" active":""); b.textContent=label;
  b.onclick=()=>switchPage(id,b);
  b.dataset.page=id; if(isAdmin) b.dataset.admin="1";
  tabsEl.appendChild(b);
});
function switchPage(id,btn){
  document.querySelectorAll("[data-page]").forEach(s=>s.hidden = s.getAttribute("data-page")!==id);
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  btn?.classList.add("active");
  render();
}
function gateTabs(){
  const me=getMe();
  document.querySelectorAll(".tab").forEach(t=>{
    if(t.dataset.admin==="1") t.style.display = (me?.isAdmin? "inline-block":"none");
  });
}

/* ======================= Employees ======================= */
function deleteEmployee(id){
  const e=db.employees.find(x=>x.id===id); if(!e) return;
  if(!confirm(`Delete ${e.name}? Their assignments, attempts, and training will be removed.`)) return;
  db.assignments = db.assignments.filter(a=>a.employeeId!==id);
  db.attempts    = db.attempts.filter(a=>a.employeeId!==id);
  db.training    = db.training.filter(t=>t.employeeId!==id);
  db.employees   = db.employees.filter(x=>x.id!==id);
  if(session?.userId===id){ session=null; localStorage.removeItem(SKEY); }
  ensureAdmin();
  save(`Delete employee ${e.username}`);
}

/* Edit-in-form helpers */
function clearEmpForm() {
  eId.value = "";
  eName.value = "";
  eUser.value = "";
  ePass.value = "";
  eDept.value = "";
  eShift.value = "1st";
  eHire.value = "";
  eActive.value = "true";
  eAdmin.value = "false";
  document.getElementById("btnSaveEmp").textContent = "Add";
  document.getElementById("btnCancelEmp").hidden = true;
}
function startEditEmp(id){
  const emp = db.employees.find(x=>x.id===id); if(!emp) return;
  eId.value = emp.id;
  eName.value = emp.name || "";
  eUser.value = emp.username || "";
  ePass.value = ""; // leave blank to keep unchanged
  eDept.value = emp.dept || "";
  eShift.value = emp.shift || "1st";
  eHire.value = emp.hire || "";
  eActive.value = String(!!emp.active);
  eAdmin.value = String(!!emp.isAdmin);
  document.getElementById("btnSaveEmp").textContent = "Update";
  document.getElementById("btnCancelEmp").hidden = false;
}
document.getElementById("btnCancelEmp").onclick = clearEmpForm;

document.getElementById("btnSaveEmp").onclick = ()=>{
  const payload = {
    id: eId.value ? +eId.value : null,
    name: eName.value.trim(),
    username: eUser.value.trim(),
    password: ePass.value,
    dept: eDept.value.trim(),
    shift: eShift.value,
    hire: eHire.value,
    active: eActive.value==="true",
    isAdmin: eAdmin.value==="true"
  };
  if(!payload.name || !payload.username || (!payload.id && !payload.password)){
    alert("Name, username, and password (for new user) are required."); return;
  }
  if(payload.id){
    const emp = db.employees.find(x=>x.id===payload.id); if(!emp) return;
    if(db.employees.some(x=>x.username===payload.username && x.id!==payload.id)){
      alert("Username already exists."); return;
    }
    emp.name = payload.name;
    emp.username = payload.username;
    if(payload.password.trim()) emp.password = payload.password.trim();
    emp.dept = payload.dept;
    emp.shift = payload.shift;
    emp.hire = payload.hire;
    emp.active = payload.active;
    emp.isAdmin = payload.isAdmin;
    ensureAdmin(); // if you removed admin from the only admin, ensure one exists
    save(`Update employee ${emp.username}`);
  }else{
    if(db.employees.some(x=>x.username===payload.username)){ alert("Username already exists."); return; }
    addEmployee({name:payload.name, username:payload.username, password:payload.password.trim(), isAdmin:payload.isAdmin, active:payload.active, dept:payload.dept, shift:payload.shift, hire:payload.hire});
  }
  clearEmpForm();
}

function startReset(id){
  const e=db.employees.find(x=>x.id===id); if(!e) return;
  const np = prompt(`New password for ${e.username}:`,"");
  if(np && np.trim()){ e.password=np.trim(); save(`Reset password for ${e.username}`); }
}

/* ======================= Machines ======================= */
function deleteMachine(id){
  const m=db.machines.find(x=>x.id===id); if(!m) return;
  if(!confirm(`Delete machine "${m.name}"? It will be unlinked from quizzes; historical training kept.`)) return;
  db.training = db.training.filter(t=>t.machineId!==id);
  db.quizzes.forEach(q=> q.machineIds = (q.machineIds||[]).filter(mid=>mid!==id));
  db.machines = db.machines.filter(x=>x.id!==id);
  save(`Delete machine ${m.name}`);
}

/* ======================= Quizzes ======================= */
let editingQuizId = null;
function addQuestionBox(type="single", preset=null){
  const box=document.createElement("div"); box.className="qbox";
  const qid = crypto.randomUUID();
  box.innerHTML=`
    <div class="row">
      <strong style="margin-right:6px;">${type==="multi"?"Multi-select":"Single-choice"}</strong>
      <span class="muted">Question</span>
    </div>
    <input data-qtext placeholder="Question text"/>
    <div data-opts></div>
    <div class="row">
      <button class="btn" data-addopt>+ Option</button>
      <button class="btn bad" data-del>Remove Question</button>
    </div>
  `;
  box.dataset.qtype = type;
  const opts = box.querySelector("[data-opts]");
  function addOpt(text="", correct=false){
    const row=document.createElement("div"); row.className="optrow";
    row.innerHTML = `
      <label><input type="${type==="multi"?"checkbox":"radio"}" name="correct_${qid}" ${correct?"checked":""}/> Correct</label>
      <input type="text" placeholder="Option text" value="${text.replaceAll('"','&quot;')}"/>
      <button class="btn" type="button">✕</button>`;
    row.querySelector("button").onclick=()=>row.remove();
    opts.appendChild(row);
  }
  box.querySelector("[data-addopt]").onclick=(e)=>{e.preventDefault(); addOpt();};
  box.querySelector("[data-del]").onclick=()=>box.remove();

  if(preset){ preset.options.forEach(o=>addOpt(o.text,!!o.correct)); box.querySelector("[data-qtext]").value=preset.text; }
  else { addOpt("", true); addOpt(""); }

  document.getElementById("qList").appendChild(box);
}
function saveQuiz(){
  const title = document.getElementById("qTitle").value.trim();
  const pass = Math.max(1,Math.min(100, parseInt(document.getElementById("qPass").value||"80")));
  const active = document.getElementById("qActive").value==="true";
  const machineIds = Array.from(document.getElementById("qMachines").selectedOptions).map(o=>+o.value);
  const qBoxes = Array.from(document.querySelectorAll("#qList .qbox"));
  if(!title) return alert("Quiz title required");
  if(qBoxes.length===0) return alert("Add at least one question");
  const questions=[];
  for(const qb of qBoxes){
    const qtext = qb.querySelector("[data-qtext]").value.trim();
    const type = qb.dataset.qtype||"single";
    const rows = Array.from(qb.querySelectorAll("[data-opts] .optrow"));
    const options = rows.map(r=>{
      const txt=r.querySelector("input[type=text]").value.trim();
      const corr = r.querySelector('input[type="checkbox"],input[type="radio"]').checked;
      return txt? {id:crypto.randomUUID(), text:txt, correct:corr}:null;
    }).filter(Boolean);
    const hasCorrect = options.some(o=>o.correct);
    if(!qtext || options.length<2 || !hasCorrect) return alert("Each question needs text, ≥2 options, and at least one correct.");
    questions.push({ id:crypto.randomUUID(), type, text:qtext, options });
  }
  if(editingQuizId){
    const q=db.quizzes.find(x=>x.id===editingQuizId);
    Object.assign(q,{title, passPercent:pass, active, machineIds, questions});
    save(`Edit quiz ${title}`);
  }else{
    db.quizzes.push({ id:nextId("quizzes"), title, passPercent:pass, active, machineIds, questions });
    save(`Create quiz ${title}`);
  }
  document.getElementById("qTitle").value=""; document.getElementById("qPass").value="80";
  document.getElementById("qActive").value="true"; document.getElementById("qMachines").selectedIndex=-1;
  document.getElementById("qList").innerHTML=""; editingQuizId=null; document.getElementById("btnCancelQuiz").hidden=true;
}
function startEditQuiz(id){
  const q=db.quizzes.find(x=>x.id===id); if(!q) return;
  editingQuizId=id;
  document.getElementById("qTitle").value=q.title;
  document.getElementById("qPass").value=q.passPercent;
  document.getElementById("qActive").value=String(!!q.active);
  const sel=document.getElementById("qMachines"); for(const o of sel.options){ o.selected = q.machineIds.includes(+o.value); }
  document.getElementById("qList").innerHTML="";
  q.questions.forEach(qq=> addQuestionBox(qq.type, qq));
  document.getElementById("btnCancelQuiz").hidden=false;
}
function cancelEditQuiz(){
  editingQuizId=null;
  document.getElementById("qTitle").value=""; document.getElementById("qPass").value=80; document.getElementById("qActive").value="true";
  document.getElementById("qMachines").selectedIndex=-1; document.getElementById("qList").innerHTML="";
  document.getElementById("btnCancelQuiz").hidden=true;
}
function deleteQuiz(id){
  if(!confirm("Delete this quiz? Past attempts will remain, but quiz will be removed.")) return;
  db.quizzes = db.quizzes.filter(q=>q.id!==id);
  save("Delete quiz");
}

/* ======================= Assignments & Backfill ======================= */
function assignOne(employeeId, quizId, required, dueDate){
  if(db.assignments.some(a=>a.employeeId===employeeId && a.quizId===quizId)) return 0;
  db.assignments.push({ id:nextId("assignments"), employeeId, quizId, required, assignedOn:new Date().toISOString(), dueDate: dueDate||null });
  return 1;
}
function deleteAssignment(id){ db.assignments = db.assignments.filter(a=>a.id!==id); save("Delete assignment"); }
function backfill(empId, quizId, score, dateStr){
  const q=db.quizzes.find(x=>x.id===quizId); if(!q) return;
  const passed = score>=q.passPercent;
  db.attempts.push({ id:nextId("attempts"), employeeId:empId, quizId, scorePercent:score, passed, takenOn:(dateStr? new Date(dateStr):new Date()).toISOString(), source:"backfill" });
  if(passed){
    for(const mid of (q.machineIds||[])){
      if(!db.training.some(t=>t.employeeId===empId && t.machineId===mid)){
        db.training.push({ id:nextId("training"), employeeId:empId, machineId:mid, trainedOn: (dateStr? new Date(dateStr):new Date()).toISOString() });
      }
    }
  }
  save(`Backfill ${empId}->${quizId} score ${score}`);
}

/* ======================= Take Quiz ======================= */
let takeContext=null;
function openTake(empId, quizId){
  const e=db.employees.find(x=>x.id===empId), q=db.quizzes.find(x=>x.id===quizId); if(!e||!q) return;
  takeContext={empId,quizId};
  document.getElementById("takeTitle").textContent = `${q.title} (Pass ${q.passPercent}%)`;
  const f=document.getElementById("takeForm"); f.innerHTML="";
  q.questions.forEach((qq,ix)=>{
    const b=document.createElement("div"); b.className="qbox";
    b.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">${ix+1}. ${qq.text}${qq.type==="multi"?' <span class="tag">Multi-select</span>':''}</div>`;
    qq.options.forEach((op)=>{
      const row=document.createElement("div"); row.className="optrow";
      row.innerHTML = `<label><input ${qq.type==="multi"?"type='checkbox'":"type='radio'"} name="q_${qq.id}" value="${op.id}"> ${op.text}</label>`;
      b.appendChild(row);
    });
    f.appendChild(b);
  });
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll("[data-page]").forEach(s=>s.hidden = s.getAttribute("data-page")!=="take");
  document.getElementById("takeResult").textContent="";
  document.getElementById("takeReview").hidden=true;
}
document.getElementById("btnCancelTake").onclick=()=>{ switchToDefault(); };

document.getElementById("btnSubmitTake").onclick=(e)=>{
  e.preventDefault();
  if(!takeContext) return;
  const q=db.quizzes.find(x=>x.id===takeContext.quizId); if(!q) return;
  const f=document.getElementById("takeForm");
  let correct=0,total=q.questions.length;
  const reviewLines=[];
  for(const qq of q.questions){
    const name=`q_${qq.id}`;
    let chosen=[];
    if(qq.type==="multi") chosen = Array.from(f.querySelectorAll(`input[name='${name}']:checked`)).map(i=>i.value);
    else { const s=f.querySelector(`input[name='${name}']:checked`); if(!s) return alert("Answer all questions"); chosen=[s.value]; }
    const correctIds = qq.options.filter(o=>o.correct).map(o=>String(o.id));
    const ok = arraysEqual(new Set(chosen), new Set(correctIds));
    if(ok) correct++;
    const chosenText = qq.options.filter(o=>chosen.includes(String(o.id))).map(o=>o.text).join("; ") || "(none)";
    const correctText = qq.options.filter(o=>o.correct).map(o=>o.text).join("; ");
    reviewLines.push(`${ok?"✓":"✗"} ${qq.text}  — Your answer: ${chosenText}  — Correct: ${correctText}`);
  }
  const score = Math.round((correct/total)*100);
  const passed = score>=q.passPercent;

  const alreadyPassed = db.attempts.some(a=>a.employeeId===takeContext.empId && a.quizId===takeContext.quizId && a.passed);
  db.attempts.push({ id:nextId("attempts"), employeeId:takeContext.empId, quizId:takeContext.quizId, scorePercent:score, passed, takenOn:new Date().toISOString(), source:"take" });

  if(passed && !db.training.some(t=>t.employeeId===takeContext.empId && q.machineIds.includes(t.machineId))){
    for(const mid of (q.machineIds||[])){
      if(!db.training.some(t=>t.employeeId===takeContext.empId && t.machineId===mid)){
        db.training.push({ id:nextId("training"), employeeId:takeContext.empId, machineId:mid, trainedOn:new Date().toISOString() });
      }
    }
  }
  save(`Quiz taken: ${q.title} (${score}%)`);

  const msg = `${score}% — ${passed?"Passed":"Failed"}${alreadyPassed?" (locked: already passed before)":" (you can retry)"}`
  document.getElementById("takeResult").textContent=msg;
  const rv=document.getElementById("takeReview"); rv.hidden=false; rv.innerHTML="<strong>Review</strong><br>"+reviewLines.map(l=>`<div>${l}</div>`).join("");
  if(alreadyPassed || passed){
    document.getElementById("btnSubmitTake").disabled=true;
  }
};

/* helpers */
function arraysEqual(aSet,bSet){ if(aSet.size!==bSet.size) return false; for(const v of aSet) if(!bSet.has(v)) return false; return true; }
function switchToDefault(){
  const me=getMe();
  const tabBtn = Array.from(document.querySelectorAll(".tab")).find(t=>t.dataset.page==(me?.isAdmin?"employees":"profile"));
  tabBtn?.click();
}

/* ======================= Render ======================= */
function render(){
  gateTabs();
  const me = getMe();
  document.getElementById("loginStatus").textContent = me? `Logged in as ${me.name} (${me.isAdmin?"Admin":"Employee"})` : "Not logged in";

  // Employees
  const tb=document.querySelector("#empTable tbody");
  if(tb){
    document.getElementById("empCount").textContent=`${db.employees.length} employee(s)`;
    tb.innerHTML="";
    db.employees.forEach(e=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${e.name}</td><td>${e.username}</td><td>${e.dept||"—"}</td><td>${e.shift||"—"}</td><td>${e.hire||"—"}</td>
        <td>${e.active?'<span class="tag pill-ok">Active</span>':'<span class="tag pill-bad">Inactive</span>'}</td>
        <td>${e.isAdmin?'Admin':'Employee'}</td>
        <td class="row">
          <button class="btn" onclick="startEditEmp(${e.id})">Edit</button>
          <button class="btn" onclick="startReset(${e.id})">Reset PW</button>
          <button class="btn bad" onclick="deleteEmployee(${e.id})">Delete</button>
        </td>`;
      tb.appendChild(tr);
    });
  }

  // Machines
  const mtb=document.querySelector("#mTable tbody");
  if(mtb){
    mtb.innerHTML="";
    db.machines.forEach(m=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${m.name}</td><td>${m.dept||"—"}</td><td>${m.active?'<span class="tag pill-ok">Active</span>':'<span class="tag pill-bad">Inactive</span>'}</td>
        <td><button class="btn bad" onclick="deleteMachine(${m.id})">Delete</button></td>`;
      mtb.appendChild(tr);
    });
  }

  // Quiz machine choices and table
  const qSel=document.getElementById("qMachines");
  if(qSel){
    qSel.innerHTML="";
    db.machines.forEach(m=>{ const o=document.createElement("option"); o.value=m.id; o.textContent=`${m.name} ${m.dept?'— '+m.dept:''}`; qSel.appendChild(o); });
  }
  const qtb=document.querySelector("#qTable tbody");
  if(qtb){
    qtb.innerHTML="";
    db.quizzes.forEach(q=>{
      const machines = (q.machineIds||[]).map(id=>db.machines.find(m=>m.id===id)?.name||"(deleted)").join(", ");
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${q.title}</td><td>${q.passPercent}%</td><td>${q.questions?.length||0}</td><td>${machines||"—"}</td>
        <td>${q.active?'<span class="tag pill-ok">Active</span>':'<span class="tag pill-bad">Inactive</span>'}</td>
        <td><button class="btn" onclick="startEditQuiz(${q.id})">Edit</button>
            <button class="btn bad" onclick="deleteQuiz(${q.id})">Delete</button></td>`;
      qtb.appendChild(tr);
    });
  }

  // Assign choices & table
  const asEmp=document.getElementById("asEmp"); if(asEmp){ asEmp.innerHTML=""; db.employees.filter(e=>e.active).forEach(e=>{ const o=document.createElement("option"); o.value=e.id; o.textContent=`${e.name} (${e.username})`; asEmp.appendChild(o); }); }
  const asQuiz=document.getElementById("asQuiz"); if(asQuiz){ asQuiz.innerHTML=""; db.quizzes.filter(q=>q.active).forEach(q=>{ const o=document.createElement("option"); o.value=q.id; o.textContent=q.title; asQuiz.appendChild(o); }); }
  const astb=document.querySelector("#asTable tbody"); if(astb){
    astb.innerHTML="";
    db.assignments.forEach(a=>{
      const e=db.employees.find(x=>x.id===a.employeeId), q=db.quizzes.find(x=>x.id===a.quizId);
      const tr=document.createElement("tr");
      const due = a.dueDate? new Date(a.dueDate) : null;
      tr.innerHTML = `<td>${e?e.name:"(deleted)"}</td><td>${q?q.title:"(deleted)"}</td><td>${a.required?"Yes":"No"}</td>
        <td>${new Date(a.assignedOn).toLocaleDateString()}</td>
        <td>${due? due.toLocaleDateString():"—"}</td>
        <td><button class="btn bad" onclick="deleteAssignment(${a.id})">Remove</button></td>`;
      astb.appendChild(tr);
    });
  }

  // Backfill choices
  const bfEmp=document.getElementById("bfEmp"); if(bfEmp){ bfEmp.innerHTML=""; db.employees.forEach(e=>{ const o=document.createElement("option"); o.value=e.id; o.textContent=`${e.name} (${e.username})`; bfEmp.appendChild(o); }); }
  const bfQuiz=document.getElementById("bfQuiz"); if(bfQuiz){ bfQuiz.innerHTML=""; db.quizzes.forEach(q=>{ const o=document.createElement("option"); o.value=q.id; o.textContent=q.title; bfQuiz.appendChild(o); }); }

  // Reports: shift counts
  const sc=document.getElementById("shiftCounts");
  if(sc){
    const byShift={"1st":0,"2nd":0,"3rd":0};
    db.employees.filter(e=>e.active).forEach(e=>{ byShift[e.shift]=(byShift[e.shift]||0)+1; });
    sc.innerHTML = `<div>1st Shift: ${byShift["1st"]||0}</div><div>2nd Shift: ${byShift["2nd"]||0}</div><div>3rd Shift: ${byShift["3rd"]||0}</div>`;
    document.getElementById("shiftTableArea").innerHTML = `<table><thead><tr><th>Shift</th><th>Count</th></tr></thead>
      <tbody><tr><td>1st</td><td>${byShift["1st"]||0}</td></tr><tr><td>2nd</td><td>${byShift["2nd"]||0}</td></tr><tr><td>3rd</td><td>${byShift["3rd"]||0}</td></tr></tbody></table>`;
  }
  // Audit log
  const al=document.getElementById("auditList"); if(al){ al.innerHTML = db.audit.map(a=>`<li class="muted">${a}</li>`).join("") || "<li class='muted'>No actions yet</li>"; }

  // Profile
  if(document.getElementById("pInfo")){
    if(!me){ document.getElementById("pInfo").innerHTML='<span class="muted">Login to see your profile.</span>'; return; }
    const attempts = db.attempts.filter(a=>a.employeeId===me.id);
    const passedQ = new Set(attempts.filter(a=>a.passed).map(a=>a.quizId));
    const trained = [];
    for(const t of db.training.filter(t=>t.employeeId===me.id)){
      const m=db.machines.find(x=>x.id===t.machineId); if(!m) continue;
      trained.push({name:m.name, date: t.trainedOn});
    }
    const pT=document.getElementById("pTrained"); pT.innerHTML="";
    if(!trained.length){ pT.innerHTML='<li class="muted">None yet</li>'; }
    else {
      trained.forEach(t=>{
        const li=document.createElement("li");
        const d=new Date(t.date);
        const expired = (Date.now()-d.getTime()) > (365*24*3600*1000);
        li.innerHTML = `${t.name} • ${d.toLocaleDateString()} ${expired?'<span class="tag pill-warn">Expires/Expired (12mo)</span>':''}`;
        pT.appendChild(li);
      });
    }
    const pC=document.getElementById("pCompleted"); pC.innerHTML="";
    attempts.sort((a,b)=>new Date(b.takenOn)-new Date(a.takenOn)).forEach(a=>{
      const q=db.quizzes.find(x=>x.id===a.quizId);
      const li=document.createElement("li");
      li.textContent = `${q? q.title:"(deleted)"} — ${a.scorePercent}% — ${a.passed?"Passed":"Failed"} — ${new Date(a.takenOn).toLocaleDateString()}`;
      pC.appendChild(li);
    });
    const assigned = db.assignments.filter(a=>a.employeeId===me.id);
    const outstanding = assigned.filter(a=>!passedQ.has(a.quizId));
    const pA=document.getElementById("pAssigned"); pA.innerHTML="";
    outstanding.forEach(a=>{
      const q=db.quizzes.find(x=>x.id===a.quizId);
      const due = a.dueDate? new Date(a.dueDate):null;
      const bad = due && new Date()>due;
      const li=document.createElement("li");
      li.innerHTML = `${q? q.title:"(deleted)"} ${bad?'<span class="tag pill-bad">Overdue</span>':''} ${(!bad && due)?'<span class="tag">Due '+due.toLocaleDateString()+'</span>':''}
        <button class="btn" onclick="openTake(${me.id}, ${a.quizId})" ${hasPassed(me.id,a.quizId)?'disabled':''}>Take</button>`;
      pA.appendChild(li);
    });
    document.getElementById("pInfo").innerHTML = `<div><strong>${me.name}</strong><div class="muted">${me.username} • ${me.dept||"—"} • ${me.shift||"—"} • Hired ${me.hire||"—"}</div></div>`;
    drawProfileChart("pChart", passedQ.size, assigned.length);
  }
}

/* ======================= Buttons / Handlers ======================= */
// Login
document.getElementById("btnLogin").onclick=()=>{
  const u=(document.getElementById("loginUser").value||"").trim();
  const p=(document.getElementById("loginPass").value||"").trim();
  const user = db.employees.find(e=>e.username===u && e.password===p && e.active!==false);
  if(user){
    session={userId:user.id};
    localStorage.setItem(SKEY, JSON.stringify(session));
    render();
    const goto = user.isAdmin?"employees":"profile";
    Array.from(document.querySelectorAll(".tab")).find(t=>t.dataset.page===goto)?.click();
  } else {
    document.getElementById("loginStatus").textContent="Invalid credentials or inactive user.";
  }
};
document.getElementById("btnLogout").onclick=()=>{
  session=null;
  localStorage.removeItem(SKEY);
  document.getElementById("loginUser").value="";
  document.getElementById("loginPass").value="";
  render();
  Array.from(document.querySelectorAll(".tab"))[0].click();
};

// Export/Import JSON
document.getElementById("btnExport").onclick=()=>{
  const blob=new Blob([JSON.stringify(db,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="training_portal_backup.json"; a.click();
};
document.getElementById("impJson").onchange=(e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{ db=JSON.parse(r.result); ensureAdmin(); save("Import JSON"); }catch{ alert("Invalid JSON"); } };
  r.readAsText(f);
};
document.getElementById("btnRestoreBackup").onclick=restoreBackup;
document.getElementById("btnResetAdmin").onclick=()=>{
  if(!confirm('Recreate "admin" user with password "admin"? (If an admin named admin exists, its password will be reset.)')) return;
  let a = db.employees.find(e=>e.username==="admin");
  if(a){ a.password="admin"; a.isAdmin=true; a.active=true; }
  else { addEmployee({name:"Admin", username:"admin", password:"admin", isAdmin:true, active:true, dept:"", shift:"1st", hire:""}, false); }
  save("Reset admin credentials");
  alert('Admin reset: username "admin", password "admin".');
};

// Import Employees CSV
document.getElementById("btnImpEmp").onclick=()=>{
  const f=document.getElementById("empCsv").files[0]; if(!f) return alert("Choose a CSV");
  const r=new FileReader();
  r.onload=()=>{
    const rows=parseCsv(r.result);
    const hdr=rows[0].map(h=>h.toLowerCase());
    const iF=hdr.indexOf("firstname"), iL=hdr.indexOf("lastname"), iU=hdr.indexOf("username"), iD=hdr.indexOf("dept"), iS=hdr.indexOf("shift"), iA=hdr.indexOf("active(true/false)"), iAd=hdr.indexOf("isadmin(true/false)"), iH=hdr.indexOf("hiredate(yyyy-mm-dd)");
    let ok=0;
    for(let i=1;i<rows.length;i++){
      const row=rows[i];
      const name=[row[iF]||"",row[iL]||""].join(" ").trim();
      const username=row[iU]||"";
      if(!name||!username) continue;
      if(db.employees.some(e=>e.username===username)) continue;
      addEmployee({name,username,password:"changeme",dept:row[iD]||"",shift:row[iS]||"1st",active:((row[iA]||"true").toLowerCase()==="true"),isAdmin:((row[iAd]||"false").toLowerCase()==="true"),hire:row[iH]||""}, false);
      ok++;
    }
    ensureAdmin();
    save(`Import ${ok} employees (CSV)`);
    alert(`Imported ${ok} employees from CSV.`);
  };
  r.readAsText(f);
};

// Machines add/import
document.getElementById("btnAddMachine").onclick=()=>{
  const m={name:mName.value.trim(),dept:mDept.value.trim(),active:mActive.value==="true"};
  if(!m.name) return alert("Machine name required");
  addMachine(m);
  mName.value=mDept.value=""; mActive.value="true";
};
document.getElementById("btnImpM").onclick=()=>{
  const f=document.getElementById("mCsv").files[0]; if(!f) return alert("Choose a CSV");
  const r=new FileReader();
  r.onload=()=>{
    const rows=parseCsv(r.result); const hdr=rows[0].map(h=>h.toLowerCase());
    const iN=hdr.indexOf("name"), iD=hdr.indexOf("department"), iA=hdr.indexOf("active(true/false)");
    let ok=0;
    for(let i=1;i<rows.length;i++){
      const row=rows[i]; const name=row[iN]||""; if(!name) continue;
      addMachine({name,dept:(row[iD]||""),active:((row[iA]||"true").toLowerCase()==="true")}, false); ok++;
    }
    save(`Import ${ok} machines (CSV)`);
  };
  r.readAsText(f);
};

// Quizzes UI buttons
document.getElementById("btnAddSingle").onclick=()=>addQuestionBox("single");
document.getElementById("btnAddMulti").onclick=()=>addQuestionBox("multi");
document.getElementById("btnSaveQuiz").onclick=saveQuiz;
document.getElementById("btnCancelQuiz").onclick=cancelEditQuiz;

// Assign
document.getElementById("btnAssign").onclick=()=>{
  const empId=+document.getElementById("asEmp").value, quizId=+document.getElementById("asQuiz").value, req=document.getElementById("asReq").value==="true", due=document.getElementById("asDue").value||null;
  if(!empId||!quizId) return alert("Pick employee and quiz");
  const added=assignOne(empId,quizId,req,due);
  save(added?`Assign quiz ${quizId} to ${empId}`:"Assignment already exists");
};
document.getElementById("btnAssignDept").onclick=()=>{
  const quizId=+document.getElementById("asQuiz").value, req=document.getElementById("asReq").value==="true", due=document.getElementById("asDue").value||null;
  const dept=prompt("Department to assign to (exact match):","");
  if(!dept) return;
  let n=0; db.employees.filter(e=>e.active && e.dept===dept).forEach(e=> n+=assignOne(e.id,quizId,req,due));
  save(`Assign quiz ${quizId} to dept ${dept} (${n})`);
};
document.getElementById("btnAssignAll").onclick=()=>{
  const quizId=+document.getElementById("asQuiz").value, req=document.getElementById("asReq").value==="true", due=document.getElementById("asDue").value||null;
  let n=0; db.employees.filter(e=>e.active).forEach(e=> n+=assignOne(e.id,quizId,req,due));
  save(`Assign quiz ${quizId} to all active (${n})`);
};

// Backfill
document.getElementById("btnBackfill").onclick=()=>{
  const empId=+document.getElementById("bfEmp").value, quizId=+document.getElementById("bfQuiz").value, score=+document.getElementById("bfScore").value, date=document.getElementById("bfDate").value;
  if(!empId||!quizId) return alert("Pick employee and quiz");
  backfill(empId,quizId,Math.max(0,Math.min(100,score)),date);
  alert("Completion recorded.");
};
// Import backfill CSV
document.getElementById("btnImpBf").onclick=()=>{
  const f=document.getElementById("bfCsv").files[0]; if(!f) return alert("Choose a CSV");
  const r=new FileReader();
  r.onload=()=>{
    const rows=parseCsv(r.result); const hdr=rows[0].map(h=>h.toLowerCase());
    const iU=hdr.indexOf("employeeusername"),iQ=hdr.indexOf("quiztitle"),iD=hdr.indexOf("completedon(yyyy-mm-dd)"),iS=hdr.indexOf("score");
    let ok=0,sk=0;
    for(let i=1;i<rows.length;i++){
      const row=rows[i]; const user=(row[iU]||"").trim(); const title=(row[iQ]||"").trim();
      const emp=db.employees.find(e=>e.username===user); const quiz=db.quizzes.find(q=>q.title===title);
      if(!emp||!quiz){ sk++; continue; }
      backfill(emp.id,quiz.id, parseInt(row[iS]||"100"), row[iD]||"");
      ok++;
    }
    alert(`Imported ${ok} completions; skipped ${sk}.`);
  };
  r.readAsText(f);
};

// Reports
document.getElementById("btnExportMatrix").onclick=()=>{
  const machines=db.machines.slice();
  const header=["Name","Username","Dept","Hire",...machines.map(m=>m.name)];
  const lines=[header.join(",")];
  db.employees.forEach(e=>{
    const row=[csv(e.name),csv(e.username),csv(e.dept||""),csv(e.hire||"")];
    machines.forEach(m=>{
      const t=db.training.find(t=>t.employeeId===e.id && t.machineId===m.id);
      row.push(csv(t? new Date(t.trainedOn).toLocaleDateString():""));
    });
    lines.push(row.join(","));
  });
  const blob=new Blob([lines.join("\n")],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="training_matrix.csv"; a.click();
};

/* ======================= Profile Chart ======================= */
function drawProfileChart(id, completed, assigned){
  const c=document.getElementById(id); if(!c) return; const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const labels=["Completed","Assigned"];
  const vals=[completed, assigned];
  const max=Math.max(1, ...vals);
  const h=c.height, barW=80, gap=40, base= h-20, scale=(h-40)/max;
  ctx.font="12px system-ui"; ctx.fillStyle="#0f172a";
  vals.forEach((v,i)=>{
    const x=40 + i*(barW+gap);
    const bh = v*scale;
    ctx.fillStyle = i===0 ? "#16a34a" : "#2563eb";
    ctx.fillRect(x, base-bh, barW, bh);
    ctx.fillStyle="#0f172a";
    ctx.fillText(labels[i], x, base+14);
    ctx.fillText(String(v), x+barW/2-8, base-bh-6);
  });
}

/* ======================= Helper queries ======================= */
function hasPassed(empId, quizId){ return db.attempts.some(a=>a.employeeId===empId && a.quizId===quizId && a.passed); }

/* ======================= Boot ======================= */
Array.from(document.querySelectorAll(".tab"))[0].click();
if(getMe()){ Array.from(document.querySelectorAll(".tab")).find(t=>t.dataset.page==(getMe().isAdmin?"employees":"profile")).click(); }

/* ======================= Action bindings (after DOM) ======================= */
document.getElementById("btnAssign").disabled=false;
</script>
</body>
</html>
